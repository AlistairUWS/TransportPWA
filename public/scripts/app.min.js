function Favourite(t,e,i,o){this.name=t,this.from=e,this.to=i,this.time=o}function getDepartureList(t,e,i,o){if(t)if(e)if(i)if(o){var n=URL.replace("$$FROM$$",t).replace("$$TO$$",e).replace("$$DATE$$",i).replace("$$TIME$$",o);console.log(n),$("#journey").text("Journey to "+$("#to-box").val()),showWaitCursor("Getting departure list."),$.ajax({url:n,type:"GET",async:!0,contentType:"application/javascript",dataType:"jsonp",success:function(t){showDepartures(t.departures.all),hideWaitCursor()},error:function(t){console.dir(t),hideWaitCursor()}})}else popupAlert("Error","You must provide an earliest departure time.");else popupAlert("Error","You must give a travel date.");else popupAlert("Error","You must specify a 'to' station.");else popupAlert("Error","You must specify a 'from' station.")}function setQuicklistItem(t){var e;for(e=0;e<app.quickList.length;e+=1)if(app.quickList[e].name===t){setQuicklistJourney(app.quickList[e]),$("#options_pnl").panel("close");break}}function removeItem(t){removeQuicklistItem(t),updateQuicklist(),displayQuicklist()}function removeQuicklistItem(t){var e;for(e=0;e<app.quickList.length;e+=1)if(app.quickList[e].name===t){app.quickList.splice(e,1),$("#options_pnl").panel("close");break}}function setDefaults(){$("#date").val(getToday()),$("#time").val(getNextTime(15))}function getToday(){return(new Date).toISOString().substring(0,10)}function twoDigit(t){return t.toString().length<2?"0"+t.toString():t.toString()}function getListViewItems(){var t,e="";for(t in stations)e+="<li id='"+stations[t]+"'>"+t+"</li>";return e}function showDepartures(t){var e,i="";for(console.dir(t),e=0;e<t.length;e+=1)i+=li(t[e]);$("#list").html(i).listview("refresh"),$("#controls").collapsible("collapse")}function li(t){var e="<li><h3>",i=t.platform?t.platform:"N/A";return(e+=t.aimed_departure_time+" : Platform "+i+"</h3><p>"+t.origin_name+" - "+t.destination_name+"</p>")+"</li>"}function clearJourney(){$("#from-box").val(""),$("#to-box").val(""),setDefaults(),$("#list").empty(),$("#add-fav").prop("disabed",!1).removeClass("ui-disabled"),$(".here").prop("disabed",!1).removeClass("ui-disabled")}function updateQuicklist(){app.quickList.length>0&&localStorage.setItem("quicklist",JSON.stringify(app.quickList))}function getQuickList(){var t=localStorage.getItem("quicklist","");return null!==t?app.quickList=JSON.parse(t):app.quicklist=[],app.quickList}function displayQuicklist(){var t,e=$("#quicklist"),i="";for(e.empty(),t=0;t<app.quickList.length;t+=1)i+="<li>"+("<a href='#'>"+app.quickList[t].name+"</a><a href='#' data-icon='delete'></a>")+"</li>";e.html(i).listview().listview("refresh")}function setQuicklistJourney(t){$("#from-box").val(t.from),$("#to-box").val(t.to),$("#time").val(t.time),$("#add-fav").prop("disabled",!0).addClass("ui-disabled")}function getLocation(t){getNearbyStations(t.coords.latitude.toString().trim(),t.coords.longitude.toString().trim())}function locationError(t){console.log("Location error: "+t.message)}function getNearbyStations(t,e){var i=LOCURL.replace("$$LONG$$",e).replace("$$LAT$$",t);$.ajax({url:i,type:"GET",async:!0,contentType:"application/javascript",dataType:"jsonp",success:createNearbyStationList,error:function(t){console.dir(t)}})}function nearbyStationList(){var t,e="";for(t=0;t<app.nearbyStations.length;t+=1)e+="<li>"+app.nearbyStations[t].name+": distance "+app.nearbyStations[t].distance+"m</li>";return e}function createNearbyStationList(t){var e,i=t.stations;for(e=0;e<i.length;e+=1)app.nearbyStations.push(i[e]);console.log("List ready"),$(".here").prop("disabed",!1).removeClass("ui-disabled")}function getNextTime(t){var e=new Date,i=e.getHours(),o=e.getMinutes()+t;return o>59&&(i+=1,o-=60),console.log(twoDigit(i)+":"+twoDigit(o)),twoDigit(i)+":"+twoDigit(o)}function showWaitCursor(t){$.mobile.loading("show",{text:t,textVisible:!0,theme:"b",html:""})}function hideWaitCursor(){$.mobile.loading("hide")}function checkConnection(t,e){var i=new XMLHttpRequest,o=Math.round(1e4*Math.random()),n=!1;i.open("HEAD",t+"?rand="+o,!0);try{i.onreadystatechange=function(){if(!n)if(e instanceof Function){var t=i.status>=200&&i.status<304;e(t),n=!0}else i.status>=200&&i.status<304?(e.innerText="Online",n=!0):(e.innerText="Offline",n=!0)},i.send()}catch(t){console.log(t.message)}}"serviceWorker"in navigator&&navigator.serviceWorker.register("/service-worker.js").then(function(t){console.dir(t),console.log("[ServiceWorker] registered in browser.")}).catch(function(t){console.log("ServiceWorker registration failed: ",t)}),navigator.onLine?$("#indicator").text("Online"):$("#indicator").text("Offline");var CORE_URL="https://transportapi.com/v3/uk/",KEYS="api_key=55aa4dc0606a4f9b92730070eb510f21&app_id=6bbf63ec",URL=CORE_URL+"train/station/$$FROM$$/$$DATE$$/$$TIME$$/timetable.json?"+KEYS+"&calling_at=$$TO$$",LOCURL=CORE_URL+"train/stations/near.json?lon=$$LONG$$&lat=$$LAT$$&rpp=4&"+KEYS,app={quickList:[],nearbyStations:[],online:!1};$(document).ready(function(){checkConnection("favicon.ico",function(){navigator.geolocation.getCurrentPosition(getLocation,locationError),app.online=!0}),setDefaults(),getQuickList(),displayQuicklist(),$("#get_tt").on("click",function(){app.online?getDepartureList(stations[$("#from-box").val()],stations[$("#to-box").val()],$("#date").val(),$("#time").val()):popupAlert("Offline","You have no current Internet connection.  Try again from a different location.")});var t=getListViewItems();$("#from-list").html(t),$("#from-list").trigger("listview"),$("#from-list").hide(),$("#from-box").on("keypress",function(){$(this).val().length>2&&$("#from-list").show()}),$("#from-list li").on("click",function(){$("#from-box").val(this.textContent),$("#from-list").hide()}),$("#to-list").html(t),$("#to-list").trigger("listview"),$("#to-list").hide(),$("#to-box").on("keypress",function(){$(this).val().length>2&&$("#to-list").show()}),$("#to-list li").on("click",function(){$("#to-box").val(this.textContent),$("#to-list").hide()}),$("#from-near").on("click",function(){popupList("Nearby Stations",nearbyStationList(),function(){var t=getListSelection().split(":")[0];$("#from-box").val(t)})}),$("#to-near").on("click",function(){popupList("Nearby Stations",nearbyStationList(),function(){var t=getListSelection().split(":")[0];$("#to-box").val(t)})}),$("#add-fav").on("click",function(){var t,e=$("#from-box").val(),i=$("#to-box").val(),o=$("#time").val();popupPrompt("New Favourite","Enter a name for this journey",function(){(t=getPromptValue())&&(app.quickList.push(new Favourite(t,e,i,o)),updateQuicklist(),displayQuicklist())},null)}),$("#clear").on("click",function(){clearJourney()}),$("#quicklist").on("click","li a",function(){""===$(this).text()?removeItem($(this).parent().text()):setQuicklistItem($(this).text())}),$("#up-date").on("click",function(){var t=new Date($("#date").val());t.setDate(t.getDate()+1),$("#date").val(t.toISOString().substring(0,10))}),$("#down-date").on("click",function(){var t=new Date($("#date").val());t.setDate(t.getDate()-1),$("#date").val(t.toISOString().substring(0,10))}),$("#up-time").on("click",function(){var t=new Date(Date.parse((new Date).toDateString()+" "+$("#time").val()));t.setTime(t.getTime()+9e5),$("#time").val(t.toTimeString().substr(0,5))}),$("#down-time").on("click",function(){var t=new Date(Date.parse((new Date).toDateString()+" "+$("#time").val()));t.setTime(t.getTime()-9e5),$("#time").val(t.toTimeString().substr(0,5))})});
